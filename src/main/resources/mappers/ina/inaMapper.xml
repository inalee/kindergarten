<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- mapper는 sql쿼리 작성 및 저장 용도 -->
  <mapper namespace="com.kinder.mapper.ina.inaMapper"> <!-- namespace는 패키지와 유사한 용도임 -->
  

  <!-- 회원가입시 member insert(공통) -->
 <insert id="ina_insertChild">
  insert into children(gcode,kincode,clcode,cname,cgen,caddress,cidnum,cage,pscode,hcode,cinterest,ccaution) values 
  (#{gcode},#{kincode},#{clcode},#{cname},#{cgen},#{caddress},#{cidnum},#{cage},#{pscode},#{hcode},#{cinterest},#{ccaution})
 </insert>

<!-- memid로 gcode 찾는 sql -->
<select id="gcode_select" resultType="int">
select gcode from guardian where memid=#{memid}
</select>

<!-- gcode 통해서 아이 찿기 -->
<select id="search_mychild" resultType="ChildrenVO">
select ccode,gcode,cname,cgen,caddress,cidnum,cage from children where gcode=#{gcode}
</select>

<!-- 입소대기점수 업데이트 -->
<update id="update_rank">
update children
set crank=#{crank}
where ccode=#{ccode};
</update>

<!-- 어린이집 검색하기 -->
<select id="search_kinder" resultType="KindergartenVO">
select * from kindergarten
	<if test="sigungucode != null">
		<choose>
		<!-- kinkind 선택 / kinname은 선택 X -->
		<when test="kinkindcode != 0 and kinname == ''">
			where sigungucode=#{sigungucode} and kinkindcode=#{kinkindcode} 
		</when>
		<!-- kinkind 선택 / kinname 선택  -->
		<when test="kinkindcode != 0 and kinname != ''">
			where sigungucode=#{sigungucode} and kinkindcode=#{kinkindcode} and kinname like CONCAT('%',#{kinname},'%')
		</when>
		<!--  kinkind 선택 X / kinname 은 선택  -->
			<when test="kinkindcode == 0 and kinname != ''">
			where sigungucode=#{sigungucode} and kinname like CONCAT('%',#{kinname},'%')
			</when>
		<otherwise>
			where sigungucode=#{sigungucode} order by kinkindcode
		</otherwise>
		</choose>
	</if>
</select>

<!-- 어린이집 검색2 -->
<select id="search_kinder2" resultType="KindergartenVO">
select kinname,kinaddress from kindergarten where kincode=#{kincode}
</select>

<!-- 아이 검색 -->
<select id="search_childname" resultType="String">
select cname from children where ccode=#{ccode} 
</select>

<!--  아이의 입소신청 어린이집 갯수 출력 -->
<select id="search_kinnum" resultType="int">
select count(*) from enroll where ccode=#{ccode}
</select>

<!-- 같은 어린이집에 입소 못하게 count -->
<select id="same_kinder" resultType="int">
select count(*) from enroll where ccode=#{ccode} and kincode=#{kincode}
</select>


<!-- 입소신청 프로시저 -->
<insert id="p_enroll" statementType="CALLABLE">
{call p_waiting(#{kincode},#{ccode},#{hopedate})}
</insert>


<select id="result_enroll" resultType="EnrollVO">
select encode,statcode,date_add(enlog,interval +7 day) enlog from enroll where ccode=#{ccode} and kincode=#{kincode}
</select>


<!-- 대기목록 전체 -->
<select id="wait_list" resultType="map">
select e.encode,c.cname,k.kinname,e.hopedate,e.enlog,s.status from guardian g,children c,enroll e,kindergarten k,status_code s where c.ccode=e.ccode and k.kincode=e.kincode 
and s.statcode=e.statcode and g.gcode=c.gcode and g.gcode=#{gcode}
</select>  


<!-- 취소된건 제외, 대기 목록 select -->
<select id="wait_list2" resultType="map">
<![CDATA[
select e.encode,c.cname,k.kinname,k.kincode,e.hopedate,c.crank,s.status from guardian g,children c,enroll e,kindergarten k,status_code s where c.ccode=e.ccode and k.kincode=e.kincode 
and s.statcode=e.statcode and g.gcode=c.gcode and g.gcode=#{gcode} and e.statcode<5
]]>
</select>

<!-- 취소된 대기목록 select -->
<select id="wait_list3" resultType="map">
<![CDATA[
select e.encode,c.cname,k.kinname,e.hopedate,s.status from guardian g,children c,enroll e,kindergarten k,status_code s where c.ccode=e.ccode and k.kincode=e.kincode 
and s.statcode=e.statcode and g.gcode=c.gcode and g.gcode=#{gcode} and e.statcode>=5 and e.statcode!=7
]]>
</select>


<!-- 어린이집 입소순번 쿼리....아직 대기중인 사람들 중(취소,입소완료처리된사람들은 xxx) 몇번쨰인지 rank 구하기... -->
<select id="wait_list4" resultType="map">
<![CDATA[
SELECT @RNUM := @RNUM + 1 AS ROWNUM, encode,cname,crank,enlog
FROM
(SELECT e.encode,c.cname,c.crank,e.enlog
FROM
enroll e,children c,kindergarten k where e.ccode=c.ccode and e.kincode=k.kincode  and statcode<5 and  k.kincode=#{kincode} order by crank desc,enlog
) t,
( SELECT @RNUM := 0 ) R

]]>
</select>


</mapper>